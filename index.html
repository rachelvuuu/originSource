<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CDN Timeout & HTTP/3 Test Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    .section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
    input, button { margin: 5px; padding: 5px; }
    pre { background: #f4f4f4; padding: 10px; height: 150px; overflow-y: auto; }
  </style>
</head>
<body>
<h1>üåê CDN Timeout & HTTP/3 Test Dashboard</h1>
<p>Includes tests for WebSocket, Keep-Alive, client/origin timeout, and HTTP/3 detection.</p>

<label for="baseUrl"><strong>CDN Domain:</strong></label>
<input type="text" id="baseUrl" value="http://localhost:8080" size="50">
<hr>

<div class="section"><h2>1. WebSocket Test</h2>
  <button onclick="testWebSocket()">Connect</button>
  <button onclick="closeWebSocket()">Close</button><br>
  <input type="text" id="wsMessage" placeholder="Type message">
  <button onclick="sendWebSocket()">Send</button>
  <pre id="wsLog"></pre>
</div>

<div class="section"><h2>2. Keep-Alive Test</h2>
  <input type="number" id="keepaliveCount" value="5" min="1">
  <button onclick="testKeepAlive()">Send Repeated Fetches</button>
  <pre id="keepaliveLog"></pre>
</div>

<div class="section"><h2>3. Client Header Timeout</h2>
  <input type="number" id="headerDelay" value="30">
  <button onclick="testClientHeader()">Trigger Header Delay</button>
  <pre id="headerLog"></pre>
</div>

<div class="section"><h2>4. Client Body Timeout</h2>
  <input type="number" id="bodyDelay" value="2">
  <button onclick="testClientBody()">Trigger Slow Body</button>
  <pre id="bodyLog"></pre>
</div>

<div class="section"><h2>5. Send Timeout</h2>
  <button onclick="testSlowResponse()">Trigger Slow Response</button>
  <pre id="sendLog"></pre>
</div>

<div class="section"><h2>6. Origin Connect Timeout</h2>
  <button onclick="testOriginConnect()">Trigger Connect Timeout</button>
  <pre id="connectLog"></pre>
</div>

<div class="section"><h2>7. Origin Send Timeout</h2>
  <button onclick="testOriginSend()">Trigger Send Timeout</button>
  <pre id="originSendLog"></pre>
</div>

<div class="section"><h2>8. Origin Read Timeout</h2>
  <button onclick="testOriginRead()">Trigger Read Timeout</button>
  <pre id="readLog"></pre>
</div>

<div class="section"><h2>9. HTTP/3 Detection</h2>
  <button onclick="detectHTTP3()">Check HTTP/3</button>
  <pre id="http3Log"></pre>
</div>

<script>
let ws;
function base() {
  return document.getElementById("baseUrl").value.replace(/\/$/, "");
}
function log(id, msg) {
  const pre = document.getElementById(id);
  pre.textContent += msg + "\n";
  pre.scrollTop = pre.scrollHeight;
}
function testWebSocket() {
  const url = base().replace(/^http/, "ws") + "/ws";
  ws = new WebSocket(url);
  log("wsLog", "Connecting to " + url);
  ws.onopen = () => log("wsLog", "‚úÖ Connected");
  ws.onmessage = (e) => log("wsLog", "üì• " + e.data);
  ws.onerror = () => log("wsLog", "‚ùå Error");
  ws.onclose = () => log("wsLog", "üîå Closed");
}
function sendWebSocket() {
  const msg = document.getElementById("wsMessage").value;
  if (ws && ws.readyState === 1) {
    ws.send(msg);
    log("wsLog", "üì§ " + msg);
  } else {
    log("wsLog", "‚ö†Ô∏è WebSocket not open");
  }
}
function closeWebSocket() {
  if (ws) ws.close();
}
async function testKeepAlive() {
  const count = +document.getElementById("keepaliveCount").value;
  for (let i = 1; i <= count; i++) {
    const t0 = performance.now();
    await fetch(base()).then(() => {
      const dt = Math.round(performance.now() - t0);
      log("keepaliveLog", `Ping ${i}: completed in ${dt}ms`);
    }).catch(err => {
      log("keepaliveLog", `Ping ${i}: ‚ùå ${err}`);
    });
  }
}
function testClientHeader() {
  const delay = +document.getElementById("headerDelay").value * 1000;
  const host = base().replace(/^https?:\/\//, "");
  const socket = new WebSocket("wss://" + host + "/ws");
  setTimeout(() => {
    socket.close();
    log("headerLog", `Client Header Delay of ${delay/1000}s completed.`);
  }, delay);
}
async function testClientBody() {
  const delay = +document.getElementById("bodyDelay").value * 1000;
  const encoder = new TextEncoder();
  const words = ["This", "is", "a", "slow", "request."];
  const stream = new ReadableStream({
    async start(controller) {
      for (const word of words) {
        controller.enqueue(encoder.encode(word + " "));
        log("bodyLog", "> Sent chunk: " + word);
        await new Promise(r => setTimeout(r, delay));
      }
      controller.close();
    }
  });
  try {
    const res = await fetch(base(), {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: stream,
      duplex: "half"
    });
    log("bodyLog", "‚úÖ Response: " + res.status);
  } catch (e) {
    log("bodyLog", "‚ùå Error: " + e);
  }
}
async function testSlowResponse() {
  try {
    const res = await fetch(base() + "/slow-response");
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      log("sendLog", decoder.decode(value));
    }
  } catch (e) {
    log("sendLog", "‚ùå " + e);
  }
}
async function testOriginConnect() {
  try {
    await fetch(base() + "/simulate-connect-timeout");
    log("connectLog", "‚úÖ Connected (unexpected)");
  } catch (e) {
    log("connectLog", "‚ùå Likely connect timeout");
  }
}
async function testOriginSend() {
  try {
    const big = "X".repeat(1000000);
    await fetch(base() + "/simulate-send-timeout", {
      method: "POST", headers: { "Content-Type": "text/plain" }, body: big
    });
    log("originSendLog", "‚úÖ Data sent (unexpected)");
  } catch (e) {
    log("originSendLog", "‚ùå Likely send timeout");
  }
}
async function testOriginRead() {
  try {
    const res = await fetch(base() + "/simulate-read-timeout");
    log("readLog", "‚úÖ Response: " + res.status);
  } catch (e) {
    log("readLog", "‚ùå Likely read timeout");
  }
}
async function detectHTTP3() {
  try {
    const res = await fetch(base() + "/cdn-cgi/trace");
    const text = await res.text();
    const match = text.match(/http=(.+)/);
    if (match) {
      log("http3Log", "Detected: " + match[1]);
    } else {
      log("http3Log", "No protocol info found");
    }
  } catch (e) {
    log("http3Log", "‚ùå " + e);
  }
}
</script>
</body>
</html>