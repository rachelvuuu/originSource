<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CDN Timeout & HTTP/3 Test Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .section { border: 1px solid #ccc; padding: 1em; margin-bottom: 2em; border-radius: 6px; }
    h2 { color: #2a4f85; }
    input, button { padding: 6px; margin-top: 6px; width: 100%; }
    pre { background: #f4f4f4; padding: 1em; height: 160px; overflow: auto; border: 1px solid #aaa; }
  </style>
</head>
<body>
  <h1>üåê CDN Timeout & HTTP/3 Test Dashboard</h1>
  <div class="section"><h2>WebSocket Test</h2>
    <input type="text" id="wsUrl" value="wss://echo.websocket.events">
    <button onclick="connectWS()">Connect</button>
    <input type="text" id="wsMsg" value="Hello WebSocket">
    <button onclick="sendWS()">Send</button>
    <pre id="wsLog"></pre></div>

  <div class="section"><h2>Keep-Alive Test</h2>
    <label>Number of Pings (min 16):</label>
    <input type="number" id="pingCount" value="16" min="1">
    <button onclick="testKeepAlive()">Send Repeated Fetches</button>
    <pre id="keepLog"></pre></div>

  <div class="section"><h2>Client Header Timeout</h2>
    <input type="number" id="headerDelay" value="20">
    <button onclick="simulateHeaderDelay()">Trigger Header Delay</button>
    <pre id="headerLog"></pre></div>

  <div class="section"><h2>Client Body Timeout</h2>
    <input type="number" id="bodyDelay" value="10">
    <button onclick="simulateBodyDelay()">Trigger Delayed Body</button>
    <pre id="bodyLog"></pre></div>

  <div class="section"><h2>Send Timeout (Slow Download)</h2>
    <button onclick="simulateSendTimeout()">Start Slow Response</button>
    <pre id="sendLog"></pre></div>

  <div class="section"><h2>Origin Connect Timeout</h2>
    <button onclick="simulateOriginConnect()">Trigger Connect Timeout</button>
    <pre id="connLog"></pre></div>

  <div class="section"><h2>Origin Send Timeout</h2>
    <button onclick="simulateOriginSend()">Trigger Slow POST</button>
    <pre id="sendOriginLog"></pre></div>

  <div class="section"><h2>Origin Read Timeout</h2>
    <input type="number" id="readDelay" value="30">
    <button onclick="simulateReadDelay()">Trigger Read Delay</button>
    <pre id="readLog"></pre></div>

  <div class="section"><h2>HTTP/3 & Advanced Settings</h2>
    <button onclick="testHTTP3()">Test HTTP/3 Trace</button>
    <pre id="http3Log"></pre></div>

<script>
let ws;
function connectWS() {
  const url = document.getElementById("wsUrl").value;
  const log = document.getElementById("wsLog");
  ws = new WebSocket(url);
  log.textContent += `Connecting to ${url}\n`;
  ws.onopen = () => log.textContent += "‚úÖ Connected\n";
  ws.onmessage = e => log.textContent += `‚¨ÖÔ∏è ${e.data}\n`;
  ws.onerror = () => log.textContent += "‚ùå Error\n";
  ws.onclose = () => log.textContent += "üîå Closed\n";
}
function sendWS() {
  const msg = document.getElementById("wsMsg").value;
  ws.send(msg);
  document.getElementById("wsLog").textContent += `‚û°Ô∏è ${msg}\n`;
}
function testKeepAlive() {
  const log = document.getElementById("keepLog");
  const total = parseInt(document.getElementById("pingCount").value || 16);
  log.textContent = `üîç Testing ${total} pings ‚Äî open DevTools > Network to check TCP reuse\n`;
  let count = 0;
  function ping() {
    fetch("/api/delay-header?time=1")
      .then(r => r.text())
      .then(txt => {
        log.textContent += `Ping ${++count}: ${txt}\n`;
        if (count < total) setTimeout(ping, 500);
      });
  }
  ping();
}
function simulateHeaderDelay() {
  const delay = document.getElementById("headerDelay").value;
  fetch(`/api/delay-header?time=${delay}`)
    .then(r => r.text())
    .then(txt => document.getElementById("headerLog").textContent = txt);
}
function simulateBodyDelay() {
  const delay = parseInt(document.getElementById("bodyDelay").value);
  const encoder = new TextEncoder();
  const body = new ReadableStream({
    start(controller) {
      controller.enqueue(encoder.encode("start="));
      setTimeout(() => controller.enqueue(encoder.encode("delayed")), delay * 1000);
      setTimeout(() => controller.close(), (delay + 3) * 1000);
    }
  });
  fetch("/api/delay-body", { method: "POST", body, headers: { "x-delay": delay } })
    .then(r => r.text())
    .then(txt => document.getElementById("bodyLog").textContent = txt);
}
function simulateSendTimeout() {
  fetch("/api/slow-download")
    .then(r => r.text())
    .then(txt => document.getElementById("sendLog").textContent = txt);
}
function simulateOriginConnect() {
  fetch("/api/unreachable")
    .then(r => r.text())
    .then(txt => document.getElementById("connLog").textContent = txt)
    .catch(e => document.getElementById("connLog").textContent = "‚ùå Origin unreachable");
}
function simulateOriginSend() {
  const encoder = new TextEncoder();
  const body = new ReadableStream({
    start(controller) {
      controller.enqueue(encoder.encode("start="));
      setTimeout(() => controller.enqueue(encoder.encode("abc")), 3000);
      setTimeout(() => controller.close(), 6000);
    }
  });
  fetch("/api/slow-body", { method: "POST", body })
    .then(r => r.text())
    .then(txt => document.getElementById("sendOriginLog").textContent = txt);
}
function simulateReadDelay() {
  const delay = document.getElementById("readDelay").value;
  fetch(`/api/delay-read?time=${delay}`)
    .then(r => r.text())
    .then(txt => document.getElementById("readLog").textContent = txt);
}
function testHTTP3() {
  const log = document.getElementById("http3Log");
  fetch("https://cloudflare.com/cdn-cgi/trace")
    .then(r => r.text())
    .then(txt => log.textContent = txt)
    .catch(e => log.textContent = "‚ùå " + e);
}
</script>
</body>
</html>